// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url  	    = env("DATABASE_URL")
  // uncomment next line if you use Prisma <5.10
  // directUrl = env("DATABASE_URL_UNPOOLED")
}

enum UserRole {
  ADMIN
  NUTRITIONIST
  PATIENT
}

enum PlanType {
  FREE
  BASIC
  PREMIUM
  CUSTOM
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum AppointmentType {
  ONLINE
  PRESENCIAL
  RETORNO
}

enum MealCategory {
  BREAKFAST
  MORNING_SNACK
  LUNCH
  AFTERNOON_SNACK
  DINNER
  EVENING_SNACK
}

enum ExerciseCategory {
  CARDIO
  STRENGTH
  FLEXIBILITY
  BALANCE
  YOGA
  PILATES
}

enum NotificationType {
  APPOINTMENT_REMINDER
  NEW_MESSAGE
  MEAL_REMINDER
  WATER_REMINDER
  FEATURE_UNLOCKED
  PLAN_UPDATE
}

// ============================================
// USERS & AUTH
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(PATIENT)
  avatar    String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // MFA (Multi-Factor Authentication)
  mfaEnabled       Boolean  @default(false)
  mfaSecret        String?  // TOTP secret
  mfaBackupCodes   String[] // Códigos de backup
  lastMfaVerifiedAt DateTime?

  // LGPD Compliance
  lgpdConsent          Boolean   @default(false)
  lgpdConsentDate      DateTime?
  lgpdDataProcessing   Boolean   @default(false)
  lgpdMarketingConsent Boolean   @default(false)
  termsAcceptedAt      DateTime?
  privacyPolicyAcceptedAt DateTime?

  // Security & Audit
  lastLoginAt          DateTime?
  lastLoginIp          String?
  failedLoginAttempts  Int       @default(0)
  lockedUntil          DateTime?
  passwordChangedAt    DateTime?
  emailVerified        Boolean   @default(false)
  emailVerifiedAt      DateTime?

  // Relations
  patient                Patient?
  nutritionist           Nutritionist?
  organizationsOwned     Organization[]         @relation("OrganizationOwner")
  sentMessages           Message[]              @relation("SentMessages")
  notifications          Notification[]
  refreshTokens          RefreshToken[]
  passwordResets         PasswordReset[]
  auditLogs              AuditLog[]

  @@map("users")
}

// ============================================
// ORGANIZATIONS (Multi-tenancy)
// ============================================

model Organization {
  id          String              @id @default(uuid())
  name        String
  slug        String              @unique // URL-friendly identifier
  cnpj        String?             @unique
  logo        String?
  
  // Contact Info
  email       String?
  phone       String?
  website     String?
  
  // Address
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String              @default("Brasil")
  
  // Business Info
  description String?
  
  // Settings
  status      OrganizationStatus  @default(ACTIVE)
  maxNutritionists Int             @default(5)
  maxPatients      Int             @default(100)
  
  // Owner (ADMIN user)
  ownerId     String
  
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  
  // Relations
  owner           User            @relation("OrganizationOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  nutritionists   Nutritionist[]
  subscriptions   Subscription[]
  
  @@map("organizations")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

// ============================================
// PATIENT
// ============================================

model Patient {
  id             String   @id @default(uuid())
  userId         String   @unique
  nutritionistId String?
  planType       PlanType @default(FREE)
  
  // Dados Pessoais
  cpf            String?  @unique
  rg             String?
  birthDate      DateTime?
  gender         String?
  phone          String?
  emergencyContact String?
  emergencyPhone String?
  
  // Endereço
  address        String?
  city           String?
  state          String?
  zipCode        String?
  
  // Dados Antropométricos
  weight         Float?
  height         Float?
  bmi            Float?
  bodyFat        Float?
  muscleMass     Float?
  waistCircumference Float?
  hipCircumference   Float?
  
  // Dados Clínicos
  bloodType      String?
  allergies      String?
  chronicDiseases String?
  medications    String?
  foodRestrictions String?
  familyHistory  String?
  
  // Estilo de Vida
  physicalActivity String?
  smokingStatus    String?
  alcoholConsumption String?
  sleepHours       Float?
  stressLevel      String?
  
  // Objetivos e Observações
  goals          String?
  observations   String?
  lastConsultationDate DateTime?
  
  // Enabled Features (JSON)
  enabledFeatures Json @default("{\"ONLINE_CONSULTATIONS\":false,\"DAILY_MEAL_PLAN\":false,\"EXERCISE_LIBRARY\":false,\"DIRECT_CHAT\":false,\"PROGRESS_TRACKING\":true,\"RECIPES\":false,\"SHOPPING_LIST\":false,\"WATER_REMINDER\":true,\"MEAL_PHOTOS\":false}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  nutritionist       Nutritionist?      @relation(fields: [nutritionistId], references: [id])
  appointments       Appointment[]
  dailyMealPlans     DailyMealPlan[]
  weeklyMealPlans    WeeklyMealPlan[]
  progressEntries    ProgressEntry[]
  scheduledFeatures  ScheduledFeature[]
  conversations      Conversation[]
  consultationNotes  ConsultationNote[]

  @@map("patients")
}

// ============================================
// NUTRITIONIST
// ============================================

model Nutritionist {
  id             String  @id @default(uuid())
  userId         String  @unique
  organizationId String? // Vinculado a uma organização/clínica
  specialization String?
  crn            String? // Registro profissional
  bio            String? // Biografia/descrição
  
  // Professional Status
  isActive       Boolean @default(true)
  hiredDate      DateTime?
  
  // Availability (JSON)
  availability Json @default("{\"monday\":{\"isAvailable\":false,\"slots\":[]},\"tuesday\":{\"isAvailable\":false,\"slots\":[]},\"wednesday\":{\"isAvailable\":false,\"slots\":[]},\"thursday\":{\"isAvailable\":false,\"slots\":[]},\"friday\":{\"isAvailable\":false,\"slots\":[]},\"saturday\":{\"isAvailable\":false,\"slots\":[]},\"sunday\":{\"isAvailable\":false,\"slots\":[]}}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization?    @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  patients        Patient[]
  appointments    Appointment[]
  recipes         Recipe[]
  exercises       Exercise[]
  conversations   Conversation[]

  @@map("nutritionists")
}

// ============================================
// FEATURES
// ============================================

model ScheduledFeature {
  id          String   @id @default(uuid())
  patientId   String
  featureKey  String
  releaseDate DateTime
  isReleased  Boolean  @default(false)
  releasedAt  DateTime?
  note        String?
  createdAt   DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("scheduled_features")
}

// ============================================
// APPOINTMENTS
// ============================================

model Appointment {
  id             String            @id @default(uuid())
  patientId      String
  nutritionistId String
  dateTime       DateTime
  duration       Int               @default(60) // minutes
  type           AppointmentType   @default(ONLINE)
  status         AppointmentStatus @default(SCHEDULED)
  notes          String?
  videoRoomUrl   String?
  reminderSent   Boolean           @default(false)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  patient      Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  nutritionist Nutritionist @relation(fields: [nutritionistId], references: [id])
  conversation Conversation?

  @@map("appointments")
}

// ============================================
// CONSULTATION NOTES
// ============================================

model ConsultationNote {
  id             String   @id @default(uuid())
  patientId      String
  appointmentId  String?
  nutritionistId String
  
  // Avaliação
  currentWeight     Float?
  currentHeight     Float?
  currentBMI        Float?
  bloodPressure     String?
  heartRate         Int?
  bodyComposition   Json?   // { bodyFat, muscleMass, visceral Fat, etc }
  
  // Anamnese
  complaints        String?
  symptoms          String?
  dietaryRecall     String?
  physicalActivity  String?
  
  // Diagnóstico Nutricional
  diagnosis         String?
  
  // Plano de Tratamento
  nutritionalPlan   String?
  recommendations   String?
  goals             String?
  restrictions      String?
  
  // Prescrições
  dietPrescription  String?
  supplementation   String?
  
  // Próximas Etapas
  nextAppointment   DateTime?
  followUpNotes     String?
  
  // Anexos (JSON array de URLs)
  attachments       Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("consultation_notes")
}

// ============================================
// MEAL PLANS
// ============================================

model Food {
  id          String @id @default(uuid())
  name        String
  category    String
  servingSize String
  imageUrl    String?

  // Nutrition (JSON)
  nutrition Json // { calories, protein, carbs, fats, fiber, sodium }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  recipeIngredients RecipeIngredient[]

  @@map("foods")
}

model Recipe {
  id             String       @id @default(uuid())
  name           String
  description    String
  instructions   String[] // Array of steps
  prepTime       Int // minutes
  category       MealCategory
  imageUrl       String?
  createdBy      String

  // Nutrition (JSON)
  nutrition Json // { calories, protein, carbs, fats, fiber, sodium }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  nutritionist   Nutritionist       @relation(fields: [createdBy], references: [id])
  ingredients    RecipeIngredient[]
  mealPlanItems  MealPlanItem[]

  @@map("recipes")
}

model RecipeIngredient {
  id       String @id @default(uuid())
  recipeId String
  foodId   String
  quantity Float
  unit     String

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  food   Food   @relation(fields: [foodId], references: [id])

  @@map("recipe_ingredients")
}

model DailyMealPlan {
  id        String   @id @default(uuid())
  patientId String
  date      DateTime
  notes     String?

  // Total Nutrition (JSON)
  totalNutrition Json // { calories, protein, carbs, fats, fiber, sodium }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patient Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  meals   MealPlanItem[]

  @@map("daily_meal_plans")
}

model MealPlanItem {
  id            String       @id @default(uuid())
  planId        String
  recipeId      String
  category      MealCategory
  time          String // HH:mm format
  isConsumed    Boolean      @default(false)
  consumedAt    DateTime?
  notes         String?

  plan   DailyMealPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  recipe Recipe        @relation(fields: [recipeId], references: [id])

  @@map("meal_plan_items")
}

model WeeklyMealPlan {
  id        String   @id @default(uuid())
  patientId String
  weekStart DateTime
  weekEnd   DateTime
  createdBy String

  // Daily Plans (JSON array of DailyMealPlan IDs)
  dailyPlanIds String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("weekly_meal_plans")
}

// ============================================
// EXERCISES
// ============================================

model Exercise {
  id             String           @id @default(uuid())
  name           String
  description    String
  category       ExerciseCategory
  duration       Int // minutes
  difficulty     String // BEGINNER, INTERMEDIATE, ADVANCED
  videoUrl       String?
  thumbnailUrl   String?
  instructions   String[]
  caloriesBurned Int?
  createdBy      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  nutritionist Nutritionist @relation(fields: [createdBy], references: [id])

  @@map("exercises")
}

// ============================================
// CHAT
// ============================================

enum MessageType {
  TEXT
  IMAGE
  FILE
  AUDIO
  VIDEO
}

enum ConversationStatus {
  SCHEDULED    // Agendada mas ainda não começou
  ACTIVE       // Em andamento
  COMPLETED    // Finalizada
  CANCELLED    // Cancelada
}

model Conversation {
  id              String             @id @default(uuid())
  appointmentId   String?            @unique // Link opcional com consulta agendada
  nutritionistId  String
  patientId       String
  status          ConversationStatus @default(SCHEDULED)
  isActive        Boolean            @default(true)
  startedAt       DateTime?
  endedAt         DateTime?
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  appointment  Appointment?      @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  nutritionist Nutritionist      @relation(fields: [nutritionistId], references: [id])
  patient      Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  messages     Message[]
  videoCalls   VideoCall[]

  @@index([nutritionistId])
  @@index([patientId])
  @@index([status])
  @@map("conversations")
}

model Message {
  id             String      @id @default(uuid())
  conversationId String
  senderId       String      // User ID
  senderRole     UserRole    // NUTRITIONIST or PATIENT
  type           MessageType @default(TEXT)
  content        String      // Text content or file URL
  fileName       String?     // For files
  fileSize       Int?        // For files (bytes)
  isRead         Boolean     @default(false)
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

// ============================================
// PROGRESS TRACKING
// ============================================

model ProgressEntry {
  id         String    @id @default(uuid())
  patientId  String
  date       DateTime  @default(now())
  weight     Float?
  bodyFat    Float?
  muscleMass Float?
  waist      Float?
  hip        Float?
  chest      Float?
  photos     String[] // Array of URLs
  notes      String?
  createdAt  DateTime  @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("progress_entries")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(uuid())
  userId    String
  title     String
  body      String
  type      NotificationType
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================
// SECURITY & AUDIT (LGPD)
// ============================================

model AuditLog {
  id            String   @id @default(uuid())
  userId        String
  action        String   // CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT, etc
  resource      String   // User, Patient, Appointment, etc
  resourceId    String?
  ipAddress     String?
  userAgent     String?
  metadata      Json?    // Dados adicionais
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model DataExportRequest {
  id          String   @id @default(uuid())
  userId      String
  email       String
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  fileUrl     String?
  expiresAt   DateTime?
  requestedAt DateTime @default(now())
  completedAt DateTime?

  @@map("data_export_requests")
}

model DataDeletionRequest {
  id          String   @id @default(uuid())
  userId      String
  email       String
  reason      String?
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED, COMPLETED
  requestedAt DateTime @default(now())
  completedAt DateTime?
  approvedBy  String?

  @@map("data_deletion_requests")
}

// ============================================
// PAYMENT & SUBSCRIPTION SYSTEM
// ============================================

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  EXPIRED
}

model Subscription {
  id             String             @id @default(uuid())
  organizationId String
  plan           PlanType
  status         SubscriptionStatus @default(ACTIVE)
  startDate      DateTime           @default(now())
  endDate        DateTime?
  trialEndsAt    DateTime?
  gracePeriodEndsAt DateTime?       // Período de carência após atraso
  
  // Payment settings
  monthlyPrice   Float
  billingDay     Int                @default(1) // Dia do mês para cobrança
  
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payments     Payment[]
  alerts       PaymentAlert[]

  @@map("subscriptions")
}

model Payment {
  id             String        @id @default(uuid())
  subscriptionId String
  amount         Float
  dueDate        DateTime
  paidDate       DateTime?
  status         PaymentStatus @default(PENDING)
  method         String?       // PIX, BOLETO, CREDIT_CARD, etc
  transactionId  String?
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([dueDate])
  @@map("payments")
}

model PaymentAlert {
  id             String   @id @default(uuid())
  subscriptionId String
  message        String
  sentAt         DateTime @default(now())
  daysOverdue    Int
  
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@map("payment_alerts")
}

enum VideoCallStatus {
  WAITING
  ACTIVE
  ENDED
  CANCELLED
}

model VideoCall {
  id             String          @id @default(uuid())
  conversationId String
  roomName       String          @unique // Nome da sala Jitsi
  startedAt      DateTime        @default(now())
  endedAt        DateTime?
  duration       Int?            // Duração em minutos
  status         VideoCallStatus @default(WAITING)
  initiatedBy    String          // userId de quem iniciou
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([status])
  @@map("video_calls")
}

